{"version":3,"sources":["Service.es6"],"names":[],"mappings":"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","file":"Service.js","sourcesContent":["\"use strict\";\r\n\r\nconst Service = (function () {\r\n    let Service = class {\r\n        constructor(name, timeout_local, sse) {\r\n            this.name = name;\r\n\r\n            this.body = Service._pattern.clone();\r\n            this.cbody = Service._controller_pattern.clone();\r\n            this.body.find(\"._name\").text(name);\r\n            this.cbody.find(\"._name\").text(name);\r\n\r\n            this.bulb_ugly = new Bulb(...Bulb.blue, 0.5, 10);\r\n            this.body.find('._bulbs').append(this.bulb_ugly.body);\r\n            this.bulb_good = new Bulb(...Bulb.green, 0.5, 10);\r\n            this.body.find('._bulbs').append(this.bulb_good.body);\r\n            this.bulb_bad = new Bulb(...Bulb.red, 0.5, 10);\r\n            this.body.find('._bulbs').append(this.bulb_bad.body);\r\n\r\n            this.cbulb_ugly = new Bulb(...Bulb.blue, 0.5, 10);\r\n            this.cbody.find('._bulbs').append(this.cbulb_ugly.body);\r\n            this.cbulb_good = new Bulb(...Bulb.green, 0.5, 10);\r\n            this.cbody.find('._bulbs').append(this.cbulb_good.body);\r\n            this.cbulb_bad = new Bulb(...Bulb.red, 0.5, 10);\r\n            this.cbody.find('._bulbs').append(this.cbulb_bad.body);\r\n\r\n            this.c_local_timeout = new ProgressBar(null, timeout_local, (v, max) => formatTime(v, \"s\"), false);\r\n            this.cbody.find(\"._bars\").append(this.c_local_timeout.body);\r\n            this.c_local_timeout.startTimer();\r\n\r\n            this.sse_listener = new EventListener(sse, this);\r\n        }\r\n\r\n        init_timeouts(timeout_ping, timeout_work) {\r\n            this.timeout_ping = new ProgressBar(\r\n                \"Ping timeout\", timeout_ping,\r\n                (v, max) => formatTime(v, max > 2000 ? \"s\" : \"ms\")\r\n            );\r\n            this.body.find(\"._bars\").append(this.timeout_ping.body);\r\n            this.timeout_ping.startTimer();\r\n\r\n            this.timeout_work = new ProgressBar(\"Work timeout\", timeout_work, (v, max) => formatTime(v, \"s\"));\r\n            this.body.find(\"._bars\").append(this.timeout_work.body);\r\n        }\r\n\r\n        setStatus(status) {\r\n            let panel = this.body.find(\".panel\");\r\n            switch (status) {\r\n                case \"open_connection\":\r\n                    this.bulb_ugly.turn_blink(false);\r\n                    this.bulb_good.turn_blink(false);\r\n                    this.bulb_bad.turn_blink(false);\r\n                    panel.replaceClass(\"panel-\", \"panel-default\");\r\n                    break;\r\n\r\n                case \"lost_connection\":\r\n                    const duration = 1500;\r\n                    setTimeout(() => this.bulb_ugly.turn_blink(duration), 0);\r\n                    setTimeout(() => this.bulb_good.turn_blink(duration), duration / 3);\r\n                    setTimeout(() => this.bulb_bad.turn_blink(duration), 2 * duration / 3);\r\n                    panel.replaceClass(\"panel-\", \"panel-warning\");\r\n                    break;\r\n\r\n                case \"ready_commit\":\r\n                    panel.replaceClass(\"panel-\", \"panel-info\");\r\n                    this.bulb_good.turn();\r\n                    break;\r\n\r\n                case \"fail\":\r\n                    panel.replaceClass(\"panel-\", \"panel-danger\");\r\n                    this.timeout_work.stopTimer();\r\n                    this.timeout_ping.stopTimer();\r\n                    this.bulb_good.turn(false);\r\n                    this.bulb_bad.turn();\r\n                    break;\r\n\r\n                case \"commit\":\r\n                    panel.replaceClass(\"panel-\", \"panel-primary\");\r\n                    this.bulb_good.turn_blink();\r\n                    break;\r\n\r\n\r\n                case \"done\":\r\n                    panel.replaceClass(\"panel-\", \"panel-success\");\r\n                    this.timeout_work.stopTimer();\r\n                    break;\r\n\r\n                case \"finish\":\r\n                    this.timeout_ping.stopTimer();\r\n                    this.bulb_ugly.turn();\r\n                    this.bulb_good.turn();\r\n                    break;\r\n\r\n                case \"rollback\":\r\n                    panel.replaceClass(\"panel-\", \"panel-danger\");\r\n                    this.timeout_work.stopTimer();\r\n                    this.timeout_ping.stopTimer();\r\n                    this.bulb_ugly.turn();\r\n                    this.bulb_good.turn(false);\r\n                    this.bulb_bad.turn();\r\n                    break;\r\n\r\n                default:\r\n                    panel.replaceClass(\"panel-\", \"panel-default\");\r\n                    break;\r\n            }\r\n        }\r\n\r\n        setCStatus(status) {\r\n            let panel = this.cbody;\r\n            switch (status) {\r\n                case \"ready_commit\":\r\n                    panel.replaceClass(\"panel-\", \"panel-info\");\r\n                    this.c_local_timeout.stopTimer();\r\n                    this.cbulb_good.turn();\r\n                    break;\r\n\r\n                case \"fail\":\r\n                    panel.replaceClass(\"panel-\", \"panel-danger\");\r\n                    this.c_local_timeout.stopTimer();\r\n                    this.cbulb_good.turn(false);\r\n                    this.cbulb_bad.turn();\r\n                    break;\r\n\r\n                case \"commit\":\r\n                    panel.replaceClass(\"panel-\", \"panel-info\");\r\n                    this.cbulb_good.turn_blink();\r\n                    break;\r\n\r\n                case \"done\":\r\n                    panel.replaceClass(\"panel-\", \"panel-success\");\r\n                    this.cbulb_ugly.turn();\r\n                    this.cbulb_good.turn();\r\n                    break;\r\n\r\n                case \"rollback\":\r\n                    panel.replaceClass(\"panel-\", \"panel-danger\");\r\n                    this.c_local_timeout.stopTimer();\r\n                    this.cbulb_ugly.turn();\r\n                    this.cbulb_good.turn(false);\r\n                    this.cbulb_bad.turn();\r\n                    break;\r\n\r\n                default:\r\n                    panel.replaceClass(\"panel-\", \"panel-default\");\r\n                    break;\r\n            }\r\n        }\r\n\r\n        event(event) {\r\n            switch (event.type) {\r\n                case \"ready_commit\":\r\n                case \"fail\":\r\n                case \"commit\":\r\n                case \"done\":\r\n                case \"finish\":\r\n                case \"rollback\":\r\n                    this.setStatus(event.type);\r\n                    break;\r\n\r\n                case \"init\":\r\n                    this.init_timeouts(event.data[\"ping_timeout\"] * 2, event.data[\"result_timeout\"]);\r\n                    this.bulb_ugly.blink();\r\n                    this.bulb_good.blink();\r\n                    this.bulb_bad.blink();\r\n                    break;\r\n\r\n                case \"wait_ping\":\r\n                    this.timeout_ping.setValue(0);\r\n                    if (!this.timeout_ping.isRunning)\r\n                        this.timeout_ping.startTimer();\r\n                    break;\r\n\r\n                case \"ping\":\r\n                    this.bulb_ugly.blink();\r\n                    break;\r\n\r\n                case \"touch\":\r\n                    this.bulb_good.blink();\r\n                    this.timeout_work.startTimer();\r\n                    break;\r\n\r\n                default:\r\n                    console.warn(\"Unhandled event\", event)\r\n            }\r\n        }\r\n    };\r\n\r\n    let service_pattern = `\r\n        <div class=\"service container col-md-3\">\r\n            <div class=\"panel panel-default\">\r\n                <div class=\"panel-heading flex-h\">\r\n                    <span class=\"_name\"></span>\r\n                    <div class=\"_bulbs flex-h\"></div>\r\n                </div>\r\n                <div class=\"panel-body\">\r\n                    <div class=\"_bars panel-group\">\r\n                        <!-- Progress bars -->\r\n                    </div>                \r\n                </div>\r\n            </div>\r\n        </div>\r\n    `;\r\n\r\n    let controller_pattern = `\r\n        <div class=\"controller-service panel panel-default\">        \r\n            <div class=\"panel-heading flex-h\">\r\n                <span class=\"_name\"></span>\r\n                <div class=\"_bulbs flex-h\"></div>\r\n            </div>\r\n            <div class=\"panel-body panel-group _bars\">\r\n                <!-- Progress bars -->\r\n            </div>\r\n        </div>\r\n    `;\r\n    Service._pattern = $(service_pattern);\r\n    Service._controller_pattern = $(controller_pattern);\r\n    return Service;\r\n})();\r\n"]}