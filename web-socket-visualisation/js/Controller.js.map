{"version":3,"sources":["Controller.es6"],"names":[],"mappings":"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","file":"Controller.js","sourcesContent":["\"use strict\";\r\n\r\nconst Controller = (function () {\r\n    let Controller = class {\r\n        constructor(sse) {\r\n            this.name = \"Controller\";\r\n            this.body = Controller._pattern.clone();\r\n\r\n            this.sse_listener = new EventListener(sse, this);\r\n\r\n            this.global_timeout = new ProgressBar(\"Global timeout\", 0, (v) => formatTime(v, \"s\"));\r\n            this.body.find(\"#controller_bars\").append(this.global_timeout.body);\r\n            this.controller_services_node = this.body.find(\"#controller_services\");\r\n\r\n            this.bulb_ugly = new Bulb(...Bulb.blue, 0.5, 10, \"#bcbcbc\");\r\n            this.body.find('._bulbs').append(this.bulb_ugly.body);\r\n\r\n            this.bulb_good = new Bulb(...Bulb.green, 0.5, 10, \"#bcbcbc\");\r\n            this.body.find('._bulbs').append(this.bulb_good.body);\r\n\r\n            this.bulb_bad = new Bulb(...Bulb.red, 0.5, 10, \"#bcbcbc\");\r\n            this.body.find('._bulbs').append(this.bulb_bad.body);\r\n\r\n            if (Controller.main_node !== null) {\r\n                Controller.main_node.append(this.body);\r\n            }\r\n            if (Controller.log_node !== null) {\r\n                Controller.log_node.append(this.sse_listener.node);\r\n            }\r\n\r\n            this.controller_status = {};\r\n            this.controller_status_body = this.body.find(\"#controller_status\");\r\n            this.controller_status_formatter = new JSONFormatter(this.controller_status, 10, {\r\n                hoverPreviewEnabled: false,\r\n                theme: '',\r\n                animateOpen: false,\r\n                animateClose: false\r\n            });\r\n            this.controller_status_timer = setInterval(this.updateStatus.bind(this), 1000, this);\r\n        }\r\n\r\n        updateStatus() {\r\n            let self = this;\r\n            $.getJSON(globals.transaction_url, (data) => {\r\n                for (let [key, value] of Object.entries(data)){\r\n                    self.controller_status[key] = value;\r\n                }\r\n                self.controller_status_body.empty().append(this.controller_status_formatter.render())\r\n            })\r\n        }\r\n\r\n        init(data) {\r\n            this.global_timeout.setMax(data.timeout);\r\n            this.global_timeout.startTimer();\r\n            for (let action of data.actions) {\r\n                let n = Number(action.service.url.match(/localhost:501([0-9])/)[1]);\r\n                let service = new Service(\r\n                    \"Service #\" + n, action.service.timeout,\r\n                    `http://localhost:901${n}/debug_sse`\r\n                );\r\n                window.globals.services[action[\"_id\"]] = service;\r\n\r\n                this.controller_services_node.append(service.cbody);\r\n                if (Controller.main_node !== null) {\r\n                    Controller.main_node.append(service.body);\r\n                }\r\n                if (Controller.log_node !== null) {\r\n                    Controller.log_node.append(service.sse_listener.node);\r\n                }\r\n            }\r\n        }\r\n\r\n        setStatus(status) {\r\n            /*\r\n             case \"ready_commit\":\r\n             case \"fail\":\r\n             case \"prepare_commit\":\r\n             case \"committed\":\r\n             case \"rollback\":\r\n             */\r\n            let panel = this.body.find(\">.panel\");\r\n            switch (status) {\r\n                case \"open_connection\":\r\n                    this.bulb_ugly.turn_blink(false);\r\n                    this.bulb_good.turn_blink(false);\r\n                    this.bulb_bad.turn_blink(false);\r\n                    panel.replaceClass(\"panel-\", \"panel-default\");\r\n                    break;\r\n\r\n                case \"lost_connection\":\r\n                    const duration = 1500;\r\n                    setTimeout(() => this.bulb_ugly.turn_blink(duration), 0);\r\n                    setTimeout(() => this.bulb_good.turn_blink(duration), duration / 3);\r\n                    setTimeout(() => this.bulb_bad.turn_blink(duration), 2 * duration / 3);\r\n                    panel.replaceClass(\"panel-\", \"panel-warning\");\r\n                    break;\r\n\r\n                case \"fail\":\r\n                    panel.replaceClass(\"panel-\", \"panel-danger\");\r\n                    this.global_timeout.stopTimer();\r\n                    this.bulb_good.turn(false);\r\n                    this.bulb_bad.turn();\r\n                    break;\r\n\r\n                case \"commit\":\r\n                    panel.replaceClass(\"panel-\", \"panel-primary\");\r\n                    this.bulb_good.turn_blink();\r\n                    break;\r\n\r\n                case \"finish\":\r\n                    clearInterval(this.controller_status_timer);\r\n                    panel.replaceClass(\"panel-\", \"panel-success\");\r\n                    this.global_timeout.stopTimer();\r\n                    this.bulb_ugly.turn();\r\n                    this.bulb_good.turn();\r\n                    break;\r\n\r\n                case \"rollback\":\r\n                    panel.replaceClass(\"panel-\", \"panel-danger\");\r\n                    this.global_timeout.stopTimer();\r\n                    this.bulb_ugly.turn();\r\n                    this.bulb_good.turn(false);\r\n                    this.bulb_bad.turn();\r\n                    break;\r\n\r\n                default:\r\n                    break;\r\n            }\r\n        }\r\n\r\n        event(event) {\r\n            let service;\r\n            let chid;\r\n            this.bulb_ugly.blink();\r\n            switch (event.type) {\r\n                case \"init\":\r\n                    this.init(event.data);\r\n                    break;\r\n\r\n                case \"ready_commit\":\r\n                case \"fail\":\r\n                case \"commit\":\r\n                case \"rollback\":\r\n                case \"finish\":\r\n                    this.setStatus(event.type);\r\n                    break;\r\n\r\n                case \"init_child\":\r\n                    break;\r\n\r\n                case \"init_child_2\":\r\n                    chid = event.data[\"chid\"];\r\n                    let pt = event.data[\"ping-timeout\"];\r\n                    service = window.globals.services[chid];\r\n                    break;\r\n\r\n                case \"ping_child\":\r\n                case \"prepare_commit_child\":\r\n                    chid = event.data;\r\n                    service = window.globals.services[chid];\r\n                    service.cbulb_ugly.blink();\r\n                    break;\r\n\r\n                case \"fail_child\":\r\n                case \"commit_child\":\r\n                case \"done_child\":\r\n                case \"rollback_child\":\r\n                    chid = event.data;\r\n                    service = window.globals.services[chid];\r\n                    service.setCStatus(event.type.replace(\"_child\", \"\"));\r\n                    break;\r\n\r\n                case \"ready_commit_child\":\r\n                    chid = event.data[\"chid\"];\r\n                    service = window.globals.services[chid];\r\n                    service.setCStatus(event.type.replace(\"_child\", \"\"));\r\n                    break;\r\n\r\n                default:\r\n                    console.warn(\"Unhandled event\", event)\r\n            }\r\n        }\r\n    };\r\n\r\n    let pattern = `\r\n        <div id=\"controller_status_wrapper\" class=\"panel-group\">\r\n            <div class=\"panel panel-default\">\r\n                <div id=\"controller_status\" class=\"panel-body\">-</div>\r\n            </div>\r\n        </div>\r\n        <div id=\"controller\" class=\"container col-md-4\">\r\n            <div class=\"panel panel-default\">\r\n                <div class=\"panel-heading flex-h\">\r\n                    <span class=\"_name\">Controller</span>\r\n                    <div class=\"_bulbs flex-h\"></div>\r\n                </div>\r\n                <div class=\"panel-body\">\r\n                    <div id=\"controller_bars\" class=\"panel-group\">\r\n                        <!-- ProgressBar -->\r\n                    </div>\r\n                    <div id=\"controller_services\" class=\"panel-group\">\r\n                        <!-- Services -->\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    `;\r\n    Controller._pattern = $(pattern);\r\n    Controller.main_node = null;\r\n    Controller.log_node = null;\r\n    return Controller;\r\n})();\r\n"]}